// logic.js - Funciones para el dashboard de Coyoacán

const map = L.map('map').setView([19.33, -99.14], 12);

const basemaps = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
};
basemaps.osm.addTo(map);

const layers = {
  unidad_habitacional: L.geoJSON(null),
  zona_monumentos_historicos: L.geoJSON(null)
  // Agrega más capas según sea necesario
};

Object.values(layers).forEach(layer => layer.addTo(map));

function toggleLayer(name, visible) {
  if (visible) layers[name].addTo(map);
  else map.removeLayer(layers[name]);
}

document.querySelectorAll('.layerToggle').forEach(cb => {
  cb.addEventListener('change', (e) => {
    toggleLayer(e.target.dataset.layer, e.target.checked);
  });
});

document.getElementById('basemapSelect').addEventListener('change', e => {
  Object.values(basemaps).forEach(layer => map.removeLayer(layer));
  basemaps[e.target.value].addTo(map);
});

const drawnItems = new L.FeatureGroup().addTo(map);
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon: true, polyline: true, rectangle: true, marker: true, circle: false }
});
map.addControl(drawControl);

map.on('draw:created', function (e) {
  const layer = e.layer;
  drawnItems.addLayer(layer);

  const geojson = layer.toGeoJSON();
  const buffered = turf.buffer(geojson, 0.1, {units: 'kilometers'});

  console.log('Buffer generado:', buffered);
  // Aquí puedes llamar al backend para análisis espacial o IA
});

document.getElementById('utSelect').addEventListener('change', e => {
  const clave = e.target.value;
  console.log('Seleccionaste UT:', clave);
  // Aquí puedes hacer fetch a la geometría y presupuesto de la UT
});
